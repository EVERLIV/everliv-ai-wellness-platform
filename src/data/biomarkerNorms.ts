// Константы для нормальных значений биомаркеров с учетом пола и возраста
// Нормы основаны на рекомендациях Минздрава РФ и международных стандартах
export interface BiomarkerNorms {
  [biomarkerName: string]: {
    male?: {
      [ageGroup: string]: string;
    };
    female?: {
      [ageGroup: string]: string;
    };
    general?: string; // Общие нормы, если не зависят от пола
  };
}

export const BIOMARKER_NORMS: BiomarkerNorms = {
  // ============ ОБЩИЙ АНАЛИЗ КРОВИ ============
  'Гемоглобин': {
    male: {
      '18-64': '130-170 г/л',
      '65+': '120-160 г/л'
    },
    female: {
      '18-50': '120-150 г/л',
      '51+': '120-160 г/л'
    }
  },
  'Эритроциты': {
    male: {
      'all': '4.0-5.1 млн/мкл'
    },
    female: {
      'all': '3.7-4.7 млн/мкл'
    }
  },
  'Лейкоциты': {
    general: '4.0-9.0 тыс/мкл'
  },
  'Нейтрофилы палочкоядерные': {
    general: '1-6%'
  },
  'Нейтрофилы сегментоядерные': {
    general: '47-72%'
  },
  'Лимфоциты': {
    general: '19-37% или 1.2-3.0 тыс/мкл'
  },
  'Лимфоциты (%)': {
    general: '19-37%'
  },
  'Лимфоциты (абс)': {
    general: '1.2-3.0 тыс/мкл'
  },
  'Моноциты': {
    general: '3-11% или 0.1-0.6 тыс/мкл'
  },
  'Моноциты (%)': {
    general: '3-11%'
  },
  'Моноциты (абс)': {
    general: '0.1-0.6 тыс/мкл'
  },
  'Эозинофилы': {
    general: '0.5-5%'
  },
  'Базофилы': {
    general: '0-1%'
  },
  'Тромбоциты': {
    general: '150-450 тыс/мкл'
  },
  'Гематокрит': {
    male: {
      'all': '39-49%'
    },
    female: {
      'all': '35-45%'
    }
  },
  'MCV': {
    general: '80-100 фл'
  },
  'MCH': {
    general: '27-31 пг'
  },
  'MCHC': {
    general: '320-360 г/л'
  },
  'RDW': {
    general: '11.5-14.5%'
  },
  'СОЭ': {
    male: {
      '18-50': '2-10 мм/ч',
      '51+': '2-15 мм/ч'
    },
    female: {
      '18-50': '2-15 мм/ч',
      '51+': '2-20 мм/ч'
    }
  },
  'Скорость оседания эритроцитов (СОЭ)': {
    male: {
      '18-50': '2-10 мм/ч',
      '51+': '2-15 мм/ч'
    },
    female: {
      '18-50': '2-15 мм/ч',
      '51+': '2-20 мм/ч'
    }
  },
  'Ретикулоциты': {
    general: '0.5-2.0'
  },
  'Ретикулоциты (абсолютное количество)': {
    general: '20-100'
  },

  // ============ БИОХИМИЧЕСКИЙ АНАЛИЗ КРОВИ ============
  'Глюкоза': {
    general: '3.3-5.5 ммоль/л'
  },
  'Глюкоза натощак': {
    general: '3.3-5.5 ммоль/л'
  },
  'Глюкоза постпрандиальная': {
    general: 'до 7.8 ммоль/л'
  },
  'HbA1c': {
    general: '4.0-6.0%'
  },
  'Гликированный гемоглобин': {
    general: '4.0-6.0%'
  },
  'Фруктозамин': {
    general: '205-285 мкмоль/л'
  },

  // Белковый обмен
  'Общий белок': {
    general: '64-84 г/л'
  },
  'Альбумин': {
    general: '35-52 г/л'
  },
  'Глобулины': {
    general: '26-35 г/л'
  },
  'Альбумин/глобулин': {
    general: '1.1-2.1'
  },
  'Трансферрин': {
    general: '2.0-3.6 г/л'
  },
  'Церулоплазмин': {
    general: '0.15-0.60 г/л'
  },
  'Гаптоглобин': {
    general: '0.3-2.0 г/л'
  },

  // Азотистый обмен
  'Креатинин': {
    male: {
      'all': '62-106 мкмоль/л'
    },
    female: {
      'all': '44-80 мкмоль/л'
    }
  },
  'Мочевина': {
    general: '2.5-8.3 ммоль/л'
  },
  'Мочевая кислота': {
    male: {
      'all': '200-420 мкмоль/л'
    },
    female: {
      'all': '140-340 мкмоль/л'
    }
  },
  'Цистатин C': {
    general: '0.57-1.12 мг/л'
  },
  'СКФ': {
    general: 'выше 60 мл/мин/1.73м²'
  },

  // Пигментный обмен
  'Билирубин общий': {
    general: '5-21 мкмоль/л'
  },
  'Билирубин прямой': {
    general: '0-5 мкмоль/л'
  },
  'Билирубин непрямой': {
    general: '3-17 мкмоль/л'
  },

  // Ферменты
  'АЛТ': {
    male: {
      'all': 'до 40 Ед/л'
    },
    female: {
      'all': 'до 32 Ед/л'
    }
  },
  'АСТ': {
    male: {
      'all': 'до 40 Ед/л'
    },
    female: {
      'all': 'до 32 Ед/л'
    }
  },
  'ГГТ': {
    male: {
      'all': '10-71 Ед/л'
    },
    female: {
      'all': '6-42 Ед/л'
    }
  },
  'Щелочная фосфатаза': {
    general: '40-150 Ед/л'
  },
  'ЛДГ': {
    general: '135-225 Ед/л'
  },
  'Амилаза': {
    general: '25-125 Ед/л'
  },
  'Липаза': {
    general: '13-60 Ед/л'
  },
  'КФК': {
    male: {
      'all': '39-308 Ед/л'
    },
    female: {
      'all': '26-192 Ед/л'
    }
  },
  'КФК-МВ': {
    general: 'до 25 Ед/л'
  },
  'Альфа-амилаза': {
    general: '25-125 Ед/л'
  },
  'Панкреатическая амилаза': {
    general: '13-53 Ед/л'
  },
  'Холинэстераза': {
    male: {
      'all': '5800-14600 Ед/л'
    },
    female: {
      'all': '4260-11250 Ед/л'
    }
  },

  // Электролиты
  'Калий': {
    general: '3.5-5.1 ммоль/л'
  },
  'Натрий': {
    general: '136-145 ммоль/л'
  },
  'Хлор': {
    general: '98-107 ммоль/л'
  },
  'Кальций общий': {
    general: '2.15-2.65 ммоль/л'
  },
  'Кальций ионизированный': {
    general: '1.05-1.30 ммоль/л'
  },
  'Магний': {
    general: '0.75-1.25 ммоль/л'
  },
  'Фосфор': {
    general: '0.81-1.45 ммоль/л'
  },

  // Микроэлементы
  'Железо': {
    male: {
      'all': '11-31 мкмоль/л'
    },
    female: {
      'all': '9-30 мкмоль/л'
    }
  },
  'Ферритин': {
    male: {
      'all': '30-400 мкг/л'
    },
    female: {
      '18-50': '15-150 мкг/л',
      '51+': '15-400 мкг/л'
    }
  },
  'ОЖСС': {
    general: '45-75 мкмоль/л'
  },
  'Насыщение трансферрина': {
    general: '20-50%'
  },
  'Медь': {
    general: '11-22 мкмоль/л'
  },
  'Цинк': {
    general: '11-18 мкмоль/л'
  },
  'Селен': {
    general: '46-143 мкг/л'
  },

  // Липидный спектр
  'Холестерин общий': {
    general: 'до 5.2 ммоль/л'
  },
  'Холестерин ЛПНП': {
    general: 'до 3.0 ммоль/л'
  },
  'Холестерин ЛПВП': {
    male: {
      'all': 'выше 1.0 ммоль/л'
    },
    female: {
      'all': 'выше 1.2 ммоль/л'
    }
  },
  'Триглицериды': {
    general: 'до 1.7 ммоль/л'
  },
  'Аполипопротеин A1': {
    male: {
      'all': '1.04-2.02 г/л'
    },
    female: {
      'all': '1.08-2.25 г/л'
    }
  },
  'Аполипопротеин B': {
    male: {
      'all': '0.66-1.33 г/л'
    },
    female: {
      'all': '0.60-1.17 г/л'
    }
  },
  'Липопротеин(a)': {
    general: 'до 30 мг/дл'
  },

  // ============ ГОРМОНЫ ЩИТОВИДНОЙ ЖЕЛЕЗЫ ============
  'ТТГ': {
    general: '0.4-4.0 мЕд/л'
  },
  'Т4 свободный': {
    general: '9.0-22.0 пмоль/л'
  },
  'Т3 свободный': {
    general: '2.6-5.7 пмоль/л'
  },
  'Т4 общий': {
    general: '54-156 нмоль/л'
  },
  'Т3 общий': {
    general: '1.08-3.14 нмоль/л'
  },
  'Антитела к ТПО': {
    general: 'до 34 МЕ/мл'
  },
  'Антитела к тиреоглобулину': {
    general: 'до 115 МЕ/мл'
  },
  'Антитела к рецепторам ТТГ': {
    general: 'до 1.75 МЕ/л'
  },
  'Тиреоглобулин': {
    general: '1.4-78.0 нг/мл'
  },
  'Кальцитонин': {
    male: {
      'all': 'до 8.4 пг/мл'
    },
    female: {
      'all': 'до 5.0 пг/мл'
    }
  },

  // ============ ПАРАЩИТОВИДНЫЕ ЖЕЛЕЗЫ ============
  'Паратгормон': {
    general: '15-65 пг/мл'
  },

  // ============ ГОРМОНЫ ПОДЖЕЛУДОЧНОЙ ЖЕЛЕЗЫ ============
  'Инсулин': {
    general: '2.6-24.9 мкЕд/мл'
  },
  'C-пептид': {
    general: '0.9-7.1 нг/мл'
  },

  // ============ ГОРМОНЫ НАДПОЧЕЧНИКОВ ============
  'Кортизол': {
    general: '138-635 нмоль/л'
  },
  'Кортизол свободный в моче': {
    general: '55-193 нмоль/сут'
  },
  'АКТГ': {
    general: '7.2-63.3 пг/мл'
  },
  'Альдостерон': {
    general: '58-172 пг/мл'
  },
  'Ренин': {
    general: '4.4-46.1 мЕд/л'
  },

  // ============ ГОРМОНЫ ГИПОФИЗА ============
  'Пролактин': {
    male: {
      'all': '2.5-17.0 нг/мл'
    },
    female: {
      'follicular': '3.8-23.2 нг/мл',
      'luteal': '5.8-40.0 нг/мл',
      'postmenopausal': '1.8-20.3 нг/мл',
      'all': '3.8-23.2 нг/мл'
    }
  },
  'СТГ': {
    general: '0.0-10.0 нг/мл'
  },
  'ИФР-1': {
    male: {
      '18-25': '182-780 нг/мл',
      '26-35': '114-492 нг/мл',
      '36-45': '90-360 нг/мл',
      '46-55': '71-290 нг/мл',
      '56+': '54-250 нг/мл'
    },
    female: {
      '18-25': '123-463 нг/мл',
      '26-35': '93-372 нг/мл',
      '36-45': '74-290 нг/мл',
      '46-55': '57-240 нг/мл',
      '56+': '42-200 нг/мл'
    }
  },

  // ============ ПОЛОВЫЕ ГОРМОНЫ ============
  'ЛГ': {
    male: {
      'all': '1.7-8.6 мЕд/л'
    },
    female: {
      'фолликулярная': '2.4-12.6 мЕд/л',
      'овуляторная': '14.0-95.6 мЕд/л',
      'лютеиновая': '1.0-11.4 мЕд/л',
      'менопауза': '7.7-58.5 мЕд/л'
    }
  },
  'ФСГ': {
    male: {
      'all': '1.5-12.4 мЕд/л'
    },
    female: {
      'фолликулярная': '3.5-12.5 мЕд/л',
      'овуляторная': '4.7-21.5 мЕд/л',
      'лютеиновая': '1.7-7.7 мЕд/л',
      'менопауза': '25.8-134.8 мЕд/л'
    }
  },
  'Тестостерон': {
    male: {
      'all': '8.64-29.0 нмоль/л'
    },
    female: {
      'all': '0.29-1.67 нмоль/л'
    }
  },
  'Тестостерон свободный': {
    male: {
      'all': '4.5-42.0 пг/мл'
    },
    female: {
      'all': '0.1-6.4 пг/мл'
    }
  },
  'Эстрадиол': {
    male: {
      'all': '7.63-42.6 пг/мл'
    },
    female: {
      'фолликулярная': '12.5-166.0 пг/мл',
      'овуляторная': '85.8-498.0 пг/мл',
      'лютеиновая': '43.8-211.0 пг/мл',
      'менопауза': 'до 54.7 пг/мл'
    }
  },
  'Прогестерон': {
    male: {
      'all': '0.32-0.64 нмоль/л'
    },
    female: {
      'фолликулярная': '0.32-2.23 нмоль/л',
      'лютеиновая': '6.99-56.63 нмоль/л',
      'менопауза': 'до 0.64 нмоль/л'
    }
  },
  'ДГЭА-С': {
    male: {
      '18-30': '2.74-11.0 мкмоль/л',
      '31-50': '1.99-7.61 мкмоль/л',
      '51+': '0.95-5.73 мкмоль/л'
    },
    female: {
      '18-30': '2.05-11.67 мкмоль/л',
      '31-50': '1.65-9.15 мкмоль/л',
      '51+': '0.94-3.34 мкмоль/л'
    }
  },
  'ГСПГ': {
    male: {
      'all': '13-71 нмоль/л'
    },
    female: {
      'all': '26-110 нмоль/л'
    }
  },
  '17-ОН прогестерон': {
    male: {
      'all': '0.6-3.4 нг/мл'
    },
    female: {
      'фолликулярная': '0.2-0.9 нг/мл',
      'лютеиновая': '0.8-3.0 нг/мл'
    }
  },
  'Андростендион': {
    male: {
      'all': '0.3-3.1 нг/мл'
    },
    female: {
      'all': '0.3-3.3 нг/мл'
    }
  },

  // ============ ВИТАМИНЫ ============
  'Витамин D': {
    general: '30-100 нг/мл'
  },
  'Витамин B12': {
    general: '191-663 пг/мл'
  },
  'Фолиевая кислота': {
    general: '4.6-18.7 нг/мл'
  },
  'Витамин B1': {
    general: '66.5-200.0 нмоль/л'
  },
  'Витамин B6': {
    general: '8.7-27.2 нг/мл'
  },
  'Витамин C': {
    general: '4.0-20.0 мг/л'
  },
  'Витамин A': {
    general: '0.3-0.8 мг/л'
  },
  'Витамин E': {
    general: '5.0-18.0 мг/л'
  },
  'Витамин K': {
    general: '0.13-1.88 нг/мл'
  },

  // ============ СПЕЦИФИЧЕСКИЕ МАРКЕРЫ ============
  'Гомоцистеин': {
    general: '5-15 мкмоль/л'
  },
  'CРБ': {
    general: 'до 3.0 мг/л'
  },
  'Прокальцитонин': {
    general: 'до 0.25 нг/мл'
  },
  'Фибриноген': {
    general: '2.0-4.0 г/л'
  },
  'D-димер': {
    general: 'до 500 нг/мл'
  },
  'Антистрептолизин О': {
    general: 'до 200 МЕ/мл'
  },
  'Ревматоидный фактор': {
    general: 'до 14 МЕ/мл'
  },

  // ============ КАРДИОМАРКЕРЫ ============
  'Тропонин I': {
    general: 'до 0.04 нг/мл'
  },
  'Тропонин T': {
    general: 'до 0.014 нг/мл'
  },
  'NT-proBNP': {
    general: 'до 125 пг/мл'
  },
  'Миоглобин': {
    male: {
      'all': '28-72 нг/мл'
    },
    female: {
      'all': '25-58 нг/мл'
    }
  },

  // ============ ОНКОМАРКЕРЫ ============
  'ПСА общий': {
    male: {
      'all': 'до 4.0 нг/мл'
    }
  },
  'ПСА свободный': {
    male: {
      'all': '0.04-0.5 нг/мл'
    }
  },
  'АФП': {
    general: 'до 15 нг/мл'
  },
  'СА 19-9': {
    general: 'до 37 Ед/мл'
  },
  'СА 125': {
    general: 'до 35 Ед/мл'
  },
  'СА 15-3': {
    general: 'до 31.3 Ед/мл'
  },
  'РЭА': {
    general: 'до 5.0 нг/мл'
  },
  'СА 72-4': {
    general: 'до 6.9 Ед/мл'
  },
  'СА 242': {
    general: 'до 20 Ед/мл'
  },
  'HE4': {
    female: {
      'пременопауза': 'до 70 пмоль/л',
      'постменопауза': 'до 140 пмоль/л'
    }
  },
  'бета-ХГЧ': {
    male: {
      'all': 'до 2.5 мЕд/мл'
    },
    female: {
      'небеременные': 'до 5.0 мЕд/мл'
    }
  },

  // ============ ГЕМОСТАЗ ============
  'Протромбиновое время': {
    general: '11-15 сек'
  },
  'МНО': {
    general: '0.85-1.15'
  },
  'АЧТВ': {
    general: '28-40 сек'
  },
  'Тромбиновое время': {
    general: '14-20 сек'
  },
  'Антитромбин III': {
    general: '75-125%'
  },
  'Протеин C': {
    general: '70-130%'
  },
  'Протеин S': {
    general: '60-130%'
  },

  // ============ ИММУНОЛОГИЯ ============
  'IgG': {
    general: '7.0-16.0 г/л'
  },
  'IgA': {
    general: '0.7-4.0 г/л'
  },
  'IgM': {
    general: '0.4-2.3 г/л'
  },
  'IgE общий': {
    general: 'до 100 МЕ/мл'
  },
  'Комплемент C3': {
    general: '0.9-1.8 г/л'
  },
  'Комплемент C4': {
    general: '0.1-0.4 г/л'
  },

  // ============ АНАЛИЗ МОЧИ ============
  'Белок в моче': {
    general: 'до 0.14 г/л'
  },
  'Глюкоза в моче': {
    general: 'до 0.8 ммоль/л'
  },
  'Микроальбумин': {
    general: 'до 30 мг/л'
  },
  'Креатинин в моче': {
    male: {
      'all': '7-18 ммоль/л'
    },
    female: {
      'all': '5.3-16 ммоль/л'
    }
  }
};

// Функция для определения возрастной группы
export const getAgeGroup = (birthDate: string | null): string => {
  if (!birthDate) return 'all';
  
  const birth = new Date(birthDate);
  const today = new Date();
  const age = today.getFullYear() - birth.getFullYear();
  
  if (age < 18) return 'all';
  if (age >= 18 && age <= 25) return '18-25';
  if (age >= 26 && age <= 30) return '26-30';
  if (age >= 31 && age <= 35) return '31-35';
  if (age >= 36 && age <= 45) return '36-45';
  if (age >= 46 && age <= 50) return '46-50';
  if (age >= 51 && age <= 55) return '51-55';
  if (age >= 56 && age <= 64) return '56-64';
  if (age >= 65) return '65+';
  
  return 'all';
};

// Функция для получения нормы биомаркера
export const getBiomarkerNorm = (
  biomarkerName: string, 
  gender: string | null, 
  birthDate: string | null
): string => {
  const norms = BIOMARKER_NORMS[biomarkerName];
  
  if (!norms) {
    return 'Норма не определена';
  }
  
  // Если есть общие нормы, используем их
  if (norms.general) {
    return norms.general;
  }
  
  // Определяем пол и возрастную группу
  const ageGroup = getAgeGroup(birthDate);
  const genderKey = gender?.toLowerCase() === 'male' || gender?.toLowerCase() === 'м' ? 'male' : 'female';
  
  // Ищем нормы для конкретного пола и возраста
  if (norms[genderKey]) {
    const genderNorms = norms[genderKey];
    
    // Ищем точное совпадение возрастной группы
    if (genderNorms[ageGroup]) {
      return genderNorms[ageGroup];
    }
    
    // Если точного совпадения нет, ищем 'all'
    if (genderNorms['all']) {
      return genderNorms['all'];
    }
    
    // Возвращаем первую доступную норму
    const firstNorm = Object.values(genderNorms)[0];
    if (firstNorm) {
      return firstNorm;
    }
  }
  
  // Если нет норм для указанного пола, пробуем другой пол
  const otherGender = genderKey === 'male' ? 'female' : 'male';
  if (norms[otherGender]) {
    const otherGenderNorms = norms[otherGender];
    
    if (otherGenderNorms[ageGroup]) {
      return otherGenderNorms[ageGroup];
    }
    
    if (otherGenderNorms['all']) {
      return otherGenderNorms['all'];
    }
    
    const firstNorm = Object.values(otherGenderNorms)[0];
    if (firstNorm) {
      return firstNorm;
    }
  }
  
  return 'Норма не определена';
};