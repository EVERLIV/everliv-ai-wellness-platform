// Константы для нормальных значений биомаркеров с учетом пола и возраста
export interface BiomarkerNorms {
  [biomarkerName: string]: {
    male?: {
      [ageGroup: string]: string;
    };
    female?: {
      [ageGroup: string]: string;
    };
    general?: string; // Общие нормы, если не зависят от пола
  };
}

export const BIOMARKER_NORMS: BiomarkerNorms = {
  'Гемоглобин': {
    male: {
      '18-64': '130-170 г/л',
      '65+': '120-160 г/л'
    },
    female: {
      '18-50': '120-150 г/л',
      '51+': '120-160 г/л'
    }
  },
  'Эритроциты': {
    male: {
      'all': '4.0-5.1 млн/мкл'
    },
    female: {
      'all': '3.7-4.7 млн/мкл'
    }
  },
  'Лейкоциты': {
    general: '4.0-9.0 тыс/мкл'
  },
  'Нейтрофилы': {
    general: '2.0-5.5 тыс/мкл'
  },
  'Лимфоциты': {
    general: '1.2-3.0 тыс/мкл'
  },
  'Моноциты': {
    general: '0.1-0.6 тыс/мкл'
  },
  'Эозинофилы': {
    general: '0.02-0.3 тыс/мкл'
  },
  'Базофилы': {
    general: '0-0.065 тыс/мкл'
  },
  'Тромбоциты': {
    general: '150-450 тыс/мкл'
  },
  'Гематокрит': {
    male: {
      'all': '39-49%'
    },
    female: {
      'all': '35-45%'
    }
  },
  'MCV': {
    general: '80-100 фл'
  },
  'MCH': {
    general: '27-31 пг'
  },
  'MCHC': {
    general: '320-360 г/л'
  },
  'RDW': {
    general: '11.5-14.5%'
  },
  'СОЭ': {
    male: {
      'all': '2-10 мм/ч'
    },
    female: {
      'all': '2-15 мм/ч'
    }
  },
  'Скорость оседания эритроцитов (СОЭ)': {
    male: {
      'all': '2-10 мм/ч'
    },
    female: {
      'all': '2-15 мм/ч'
    }
  },
  'Глюкоза': {
    general: '3.3-5.5 ммоль/л'
  },
  'Глюкоза натощак': {
    general: '3.3-5.5 ммоль/л'
  },
  'Глюкоза постпрандиальная': {
    general: 'до 7.8 ммоль/л'
  },
  'HbA1c': {
    general: '4.0-6.0%'
  },
  'Гликированный гемоглобин': {
    general: '4.0-6.0%'
  },
  'Фруктозамин': {
    general: '205-285 мкмоль/л'
  },
  'Креатинин': {
    male: {
      'all': '62-106 мкмоль/л'
    },
    female: {
      'all': '44-80 мкмоль/л'
    }
  },
  'Мочевина': {
    general: '2.5-8.3 ммоль/л'
  },
  'Мочевая кислота': {
    male: {
      'all': '200-420 мкмоль/л'
    },
    female: {
      'all': '140-340 мкмоль/л'
    }
  },
  'Цистатин C': {
    general: '0.57-1.12 мг/л'
  },
  'СКФ': {
    general: 'выше 60 мл/мин/1.73м²'
  },
  'Общий белок': {
    general: '64-84 г/л'
  },
  'Альбумин': {
    general: '35-52 г/л'
  },
  'Глобулины': {
    general: '26-35 г/л'
  },
  'Альбумин/глобулин': {
    general: '1.1-2.1'
  },
  'Билирубин общий': {
    general: '5-21 мкмоль/л'
  },
  'Билирубин прямой': {
    general: '0-5 мкмоль/л'
  },
  'Билирубин непрямой': {
    general: '3-17 мкмоль/л'
  },
  'АЛТ': {
    male: {
      'all': 'до 40 Ед/л'
    },
    female: {
      'all': 'до 32 Ед/л'
    }
  },
  'АСТ': {
    male: {
      'all': 'до 40 Ед/л'
    },
    female: {
      'all': 'до 32 Ед/л'
    }
  },
  'ГГТ': {
    male: {
      'all': '10-71 Ед/л'
    },
    female: {
      'all': '6-42 Ед/л'
    }
  },
  'Щелочная фосфатаза': {
    general: '40-150 Ед/л'
  },
  'ЛДГ': {
    general: '135-225 Ед/л'
  },
  'Амилаза': {
    general: '25-125 Ед/л'
  },
  'Липаза': {
    general: '13-60 Ед/л'
  },
  'КФК': {
    male: {
      'all': '39-308 Ед/л'
    },
    female: {
      'all': '26-192 Ед/л'
    }
  },
  'Калий': {
    general: '3.5-5.1 ммоль/л'
  },
  'Натрий': {
    general: '136-145 ммоль/л'
  },
  'Хлор': {
    general: '98-107 ммоль/л'
  },
  'Кальций общий': {
    general: '2.15-2.65 ммоль/л'
  },
  'Кальций ионизированный': {
    general: '1.05-1.30 ммоль/л'
  },
  'Магний': {
    general: '0.75-1.25 ммоль/л'
  },
  'Фосфор': {
    general: '0.81-1.45 ммоль/л'
  },
  'Железо': {
    male: {
      'all': '11-31 мкмоль/л'
    },
    female: {
      'all': '9-30 мкмоль/л'
    }
  },
  'Ферритин': {
    male: {
      'all': '30-400 мкг/л'
    },
    female: {
      '18-50': '15-150 мкг/л',
      '51+': '15-400 мкг/л'
    }
  },
  'Трансферрин': {
    general: '2.0-3.6 г/л'
  },
  'ОЖСС': {
    general: '45-75 мкмоль/л'
  },
  'Насыщение трансферрина': {
    general: '20-50%'
  },
  'Холестерин общий': {
    general: 'до 5.2 ммоль/л'
  },
  'Холестерин ЛПНП': {
    general: 'до 3.0 ммоль/л'
  },
  'Холестерин ЛПВП': {
    male: {
      'all': 'выше 1.0 ммоль/л'
    },
    female: {
      'all': 'выше 1.2 ммоль/л'
    }
  },
  'Триглицериды': {
    general: 'до 1.7 ммоль/л'
  },
  'Аполипопротеин A1': {
    male: {
      'all': '1.04-2.02 г/л'
    },
    female: {
      'all': '1.08-2.25 г/л'
    }
  },
  'Аполипопротеин B': {
    male: {
      'all': '0.66-1.33 г/л'
    },
    female: {
      'all': '0.60-1.17 г/л'
    }
  },
  'Липопротеин(a)': {
    general: 'до 30 мг/дл'
  },
  'ТТГ': {
    general: '0.4-4.0 мЕд/л'
  },
  'Т4 свободный': {
    general: '9.0-22.0 пмоль/л'
  },
  'Т3 свободный': {
    general: '2.6-5.7 пмоль/л'
  },
  'Антитела к ТПО': {
    general: 'до 34 МЕ/мл'
  },
  'Антитела к тиреоглобулину': {
    general: 'до 115 МЕ/мл'
  },
  'Кальцитонин': {
    male: {
      'all': 'до 8.4 пг/мл'
    },
    female: {
      'all': 'до 5.0 пг/мл'
    }
  },
  'Паратгормон': {
    general: '15-65 пг/мл'
  },
  'Инсулин': {
    general: '2.6-24.9 мкЕд/мл'
  },
  'C-пептид': {
    general: '0.9-7.1 нг/мл'
  },
  'Кортизол': {
    general: '138-635 нмоль/л'
  },
  'АКТГ': {
    general: '7.2-63.3 пг/мл'
  },
  'Пролактин': {
    male: {
      'all': '86-324 мЕд/л'
    },
    female: {
      'all': '102-496 мЕд/л'
    }
  },
  'СТГ': {
    general: '0.0-10.0 нг/мл'
  },
  'ЛГ': {
    male: {
      'all': '1.7-8.6 мЕд/л'
    },
    female: {
      'фолликулярная': '2.4-12.6 мЕд/л',
      'овуляторная': '14.0-95.6 мЕд/л',
      'лютеиновая': '1.0-11.4 мЕд/л',
      'менопауза': '7.7-58.5 мЕд/л'
    }
  },
  'ФСГ': {
    male: {
      'all': '1.5-12.4 мЕд/л'
    },
    female: {
      'фолликулярная': '3.5-12.5 мЕд/л',
      'овуляторная': '4.7-21.5 мЕд/л',
      'лютеиновая': '1.7-7.7 мЕд/л',
      'менопауза': '25.8-134.8 мЕд/л'
    }
  },
  'Тестостерон': {
    male: {
      'all': '8.64-29.0 нмоль/л'
    },
    female: {
      'all': '0.29-1.67 нмоль/л'
    }
  },
  'Эстрадиол': {
    male: {
      'all': '7.63-42.6 пг/мл'
    },
    female: {
      'фолликулярная': '12.5-166.0 пг/мл',
      'овуляторная': '85.8-498.0 пг/мл',
      'лютеиновая': '43.8-211.0 пг/мл',
      'менопауза': 'до 54.7 пг/мл'
    }
  },
  'Прогестерон': {
    male: {
      'all': '0.32-0.64 нмоль/л'
    },
    female: {
      'фолликулярная': '0.32-2.23 нмоль/л',
      'лютеиновая': '6.99-56.63 нмоль/л',
      'менопауза': 'до 0.64 нмоль/л'
    }
  },
  'ДГЭА-С': {
    male: {
      '18-30': '2.74-11.0 мкмоль/л',
      '31-50': '1.99-7.61 мкмоль/л',
      '51+': '0.95-5.73 мкмоль/л'
    },
    female: {
      '18-30': '2.05-11.67 мкмоль/л',
      '31-50': '1.65-9.15 мкмоль/л',
      '51+': '0.94-3.34 мкмоль/л'
    }
  },
  'Витамин D': {
    general: '30-100 нг/мл'
  },
  'Витамин B12': {
    general: '191-663 пг/мл'
  },
  'Фолиевая кислота': {
    general: '4.6-18.7 нг/мл'
  },
  'Гомоцистеин': {
    general: '5-15 мкмоль/л'
  },
  'CРБ': {
    general: 'до 3.0 мг/л'
  },
  'Протромбиновое время': {
    general: '11-15 сек'
  },
  'МНО': {
    general: '0.85-1.15'
  },
  'АЧТВ': {
    general: '28-40 сек'
  },
  'Фибриноген': {
    general: '2.0-4.0 г/л'
  },
  'D-димер': {
    general: 'до 500 нг/мл'
  },
  'Ретикулоциты': {
    general: '0.5-2.0%'
  },
  'Ретикулоциты (абсолютное количество)': {
    general: '20-100 тыс/мкл'
  },
  'Антистрептолизин О': {
    general: 'до 200 МЕ/мл'
  },
  'Ревматоидный фактор': {
    general: 'до 14 МЕ/мл'
  },
  'Тропонин I': {
    general: 'до 0.04 нг/мл'
  },
  'NT-proBNP': {
    general: 'до 125 пг/мл'
  },
  'Миоглобин': {
    male: {
      'all': '28-72 нг/мл'
    },
    female: {
      'all': '25-58 нг/мл'
    }
  },
  'ПСА общий': {
    male: {
      'all': 'до 4.0 нг/мл'
    }
  },
  'ПСА свободный': {
    male: {
      'all': '0.04-0.5 нг/мл'
    }
  },
  'АФП': {
    general: 'до 15 нг/мл'
  },
  'СА 19-9': {
    general: 'до 37 Ед/мл'
  },
  'СА 125': {
    general: 'до 35 Ед/мл'
  },
  'СА 15-3': {
    general: 'до 31.3 Ед/мл'
  },
  'РЭА': {
    general: 'до 5.0 нг/мл'
  }
};

// Функция для определения возрастной группы
export const getAgeGroup = (birthDate: string | null): string => {
  if (!birthDate) return 'all';
  
  const birth = new Date(birthDate);
  const today = new Date();
  const age = today.getFullYear() - birth.getFullYear();
  
  if (age < 18) return 'all';
  if (age >= 18 && age <= 50) return '18-50';
  if (age >= 51 && age <= 64) return '51-64';
  if (age >= 65) return '65+';
  
  return 'all';
};

// Функция для получения нормы биомаркера
export const getBiomarkerNorm = (
  biomarkerName: string, 
  gender: string | null, 
  birthDate: string | null
): string => {
  const norms = BIOMARKER_NORMS[biomarkerName];
  
  if (!norms) {
    return 'Норма не определена';
  }
  
  // Если есть общие нормы, используем их
  if (norms.general) {
    return norms.general;
  }
  
  // Определяем пол и возрастную группу
  const ageGroup = getAgeGroup(birthDate);
  const genderKey = gender?.toLowerCase() === 'male' || gender?.toLowerCase() === 'м' ? 'male' : 'female';
  
  // Ищем нормы для конкретного пола и возраста
  if (norms[genderKey]) {
    const genderNorms = norms[genderKey];
    
    // Ищем точное совпадение возрастной группы
    if (genderNorms[ageGroup]) {
      return genderNorms[ageGroup];
    }
    
    // Если точного совпадения нет, ищем 'all'
    if (genderNorms['all']) {
      return genderNorms['all'];
    }
    
    // Возвращаем первую доступную норму
    const firstNorm = Object.values(genderNorms)[0];
    if (firstNorm) {
      return firstNorm;
    }
  }
  
  // Если нет норм для указанного пола, пробуем другой пол
  const otherGender = genderKey === 'male' ? 'female' : 'male';
  if (norms[otherGender]) {
    const otherGenderNorms = norms[otherGender];
    
    if (otherGenderNorms[ageGroup]) {
      return otherGenderNorms[ageGroup];
    }
    
    if (otherGenderNorms['all']) {
      return otherGenderNorms['all'];
    }
    
    const firstNorm = Object.values(otherGenderNorms)[0];
    if (firstNorm) {
      return firstNorm;
    }
  }
  
  return 'Норма не определена';
};