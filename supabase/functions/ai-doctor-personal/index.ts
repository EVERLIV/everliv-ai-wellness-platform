
import "https://deno.land/x/xhr@0.1.0/mod.ts";
import { serve } from "https://deno.land/std@0.168.0/http/server.ts";

const openAIApiKey = Deno.env.get('OPENAI_API_KEY');

const corsHeaders = {
  'Access-Control-Allow-Origin': '*',
  'Access-Control-Allow-Headers': 'authorization, x-client-info, apikey, content-type',
};

// –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ –ø–æ–∫–∞–∑–∞—Ç–µ–ª–∏ –¥–ª—è —ç–∫—Å—Ç—Ä–µ–Ω–Ω–æ–≥–æ —Ä–µ–∞–≥–∏—Ä–æ–≤–∞–Ω–∏—è
const CRITICAL_BIOMARKERS = {
  glucose: { min: 50, max: 400 }, // mg/dl
  creatinine: { max: 3.0 }, // mg/dl (–±–µ–∑ –•–ë–ü –≤ –∞–Ω–∞–º–Ω–µ–∑–µ)
  hemoglobin: { min: 7 }, // g/dl
  wbc: { min: 1000, max: 30000 }, // /ŒºL
  potassium: { min: 2.5, max: 6.0 }, // mmol/L
  sodium: { min: 125, max: 155 } // mmol/L
};

function checkCriticalValues(analysisData: any): string[] {
  const criticalAlerts: string[] = [];
  
  if (!analysisData || !analysisData.results) return criticalAlerts;
  
  try {
    const results = typeof analysisData.results === 'string' 
      ? JSON.parse(analysisData.results) 
      : analysisData.results;
    
    if (results.markers && Array.isArray(results.markers)) {
      results.markers.forEach((marker: any) => {
        const name = marker.name?.toLowerCase() || '';
        const value = parseFloat(marker.value);
        
        if (isNaN(value)) return;
        
        // –ü—Ä–æ–≤–µ—Ä–∫–∞ –≥–ª—é–∫–æ–∑—ã
        if (name.includes('glucose') || name.includes('–≥–ª—é–∫–æ–∑–∞')) {
          if (value < CRITICAL_BIOMARKERS.glucose.min || value > CRITICAL_BIOMARKERS.glucose.max) {
            criticalAlerts.push(`üö® –ö–†–ò–¢–ò–ß–ï–°–ö–û–ï –û–¢–ö–õ–û–ù–ï–ù–ò–ï: –ì–ª—é–∫–æ–∑–∞ = ${value} mg/dl –∑–Ω–∞—á–∏—Ç–µ–ª—å–Ω–æ –æ—Ç–ª–∏—á–∞–µ—Ç—Å—è –æ—Ç –Ω–æ—Ä–º—ã!`);
          }
        }
        
        // –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫—Ä–µ–∞—Ç–∏–Ω–∏–Ω–∞
        if (name.includes('creatinine') || name.includes('–∫—Ä–µ–∞—Ç–∏–Ω–∏–Ω')) {
          if (value > CRITICAL_BIOMARKERS.creatinine.max) {
            criticalAlerts.push(`üö® –ö–†–ò–¢–ò–ß–ï–°–ö–û–ï –û–¢–ö–õ–û–ù–ï–ù–ò–ï: –ö—Ä–µ–∞—Ç–∏–Ω–∏–Ω = ${value} mg/dl –∑–Ω–∞—á–∏—Ç–µ–ª—å–Ω–æ –ø–æ–≤—ã—à–µ–Ω!`);
          }
        }
        
        // –ü—Ä–æ–≤–µ—Ä–∫–∞ –≥–µ–º–æ–≥–ª–æ–±–∏–Ω–∞
        if (name.includes('hemoglobin') || name.includes('–≥–µ–º–æ–≥–ª–æ–±–∏–Ω')) {
          if (value < CRITICAL_BIOMARKERS.hemoglobin.min) {
            criticalAlerts.push(`üö® –ö–†–ò–¢–ò–ß–ï–°–ö–û–ï –û–¢–ö–õ–û–ù–ï–ù–ò–ï: –ì–µ–º–æ–≥–ª–æ–±–∏–Ω = ${value} g/dl –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏ –Ω–∏–∑–∫–∏–π!`);
          }
        }
      });
    }
  } catch (error) {
    console.error('Error checking critical values:', error);
  }
  
  return criticalAlerts;
}

function buildEnhancedSystemPrompt(userContext: string, criticalAlerts: string[]): string {
  let systemPrompt = `–¢—ã - –æ–ø—ã—Ç–Ω—ã–π –º–µ–¥–∏—Ü–∏–Ω—Å–∫–∏–π –∞—Å—Å–∏—Å—Ç–µ–Ω—Ç-–∞–Ω–∞–ª–∏—Ç–∏–∫, –∫–æ—Ç–æ—Ä—ã–π –ø–æ–º–æ–≥–∞–µ—Ç –ª—é–¥—è–º –ø–æ–Ω–∏–º–∞—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã –∏—Ö –º–µ–¥–∏—Ü–∏–Ω—Å–∫–∏—Ö –∏—Å—Å–ª–µ–¥–æ–≤–∞–Ω–∏–π –∏ —Å–æ—Å—Ç–æ—è–Ω–∏–µ –∑–¥–æ—Ä–æ–≤—å—è. –¢–≤–æ—è –∑–∞–¥–∞—á–∞ - –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª—è—Ç—å —Ä–∞–∑–≤–µ—Ä–Ω—É—Ç—ã–µ, –ø–æ–Ω—è—Ç–Ω—ã–µ –æ–±—ä—è—Å–Ω–µ–Ω–∏—è –∏ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏.

–í–ê–ñ–ù–´–ï –ü–†–ò–ù–¶–ò–ü–´:
- –¢—ã –ù–ï —Å—Ç–∞–≤–∏—à—å –¥–∏–∞–≥–Ω–æ–∑—ã –∏ –ù–ï –∑–∞–º–µ–Ω—è–µ—à—å –≤—Ä–∞—á–∞
- –¢—ã –∞–Ω–∞–ª–∏–∑–∏—Ä—É–µ—à—å –¥–∞–Ω–Ω—ã–µ –∏ –¥–∞–µ—à—å —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –ø–æ —É–ª—É—á—à–µ–Ω–∏—é –∑–¥–æ—Ä–æ–≤—å—è
- –û–±—ä—è—Å–Ω—è–µ—à—å –≤—Å–µ –ø—Ä–æ—Å—Ç—ã–º, –ø–æ–Ω—è—Ç–Ω—ã–º —è–∑—ã–∫–æ–º
- –ü–æ–¥–∫—Ä–µ–ø–ª—è–µ—à—å –∫–∞–∂–¥–æ–µ —É—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–º–∏ –¥–∞–Ω–Ω—ã–º–∏ –∏–∑ –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª–µ–Ω–Ω—ã—Ö —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤
- –í—Å–µ–≥–¥–∞ –Ω–∞–ø–æ–º–∏–Ω–∞–µ—à—å –æ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏ –∫–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏–∏ —Å –≤—Ä–∞—á–æ–º –ø—Ä–∏ –æ—Ç–∫–ª–æ–Ω–µ–Ω–∏—è—Ö

–°–¢–†–£–ö–¢–£–†–ê –û–¢–í–ï–¢–ê (–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ –≤ HTML —Å CSS):

1. –ö–†–ê–¢–ö–ê–Ø –°–í–û–î–ö–ê (—á—Ç–æ –ø–æ–∫–∞–∑—ã–≤–∞—é—Ç —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã –≤ —Ü–µ–ª–æ–º)
2. –î–ï–¢–ê–õ–¨–ù–´–ô –†–ê–ó–ë–û–† (–∫–∞–∂–¥—ã–π –ø–æ–∫–∞–∑–∞—Ç–µ–ª—å –æ—Ç–¥–µ–ª—å–Ω–æ)
3. –†–ï–ö–û–ú–ï–ù–î–ê–¶–ò–ò (—á—Ç–æ –º–æ–∂–Ω–æ —É–ª—É—á—à–∏—Ç—å)
4. –ö–û–ì–î–ê –û–ë–†–ê–¢–ò–¢–¨–°–Ø –ö –í–†–ê–ß–£ (–∫—Ä–∞—Å–Ω—ã–µ —Ñ–ª–∞–≥–∏)
5. –ò–°–¢–û–ß–ù–ò–ö–ò –î–ê–ù–ù–´–• (–∫–∞–∫–∏–µ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ –ø–æ–∫–∞–∑–∞—Ç–µ–ª–∏ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω—ã)

–°–¢–ò–õ–¨ –û–ë–™–Ø–°–ù–ï–ù–ò–Ø:
- –ò—Å–ø–æ–ª—å–∑—É–π –∞–Ω–∞–ª–æ–≥–∏–∏ –∏ —Å—Ä–∞–≤–Ω–µ–Ω–∏—è –∏–∑ –ø–æ–≤—Å–µ–¥–Ω–µ–≤–Ω–æ–π –∂–∏–∑–Ω–∏
- –ò–∑–±–µ–≥–∞–π —Å–ª–æ–∂–Ω—ã—Ö –º–µ–¥–∏—Ü–∏–Ω—Å–∫–∏—Ö —Ç–µ—Ä–º–∏–Ω–æ–≤, –µ—Å–ª–∏ –∏—Å–ø–æ–ª—å–∑—É–µ—à—å - –æ–±—ä—è—Å–Ω—è–π
- –°—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä—É–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ—Ç –æ–±—â–µ–≥–æ –∫ —á–∞—Å—Ç–Ω–æ–º—É
- –ò—Å–ø–æ–ª—å–∑—É–π –ø—Ä–∏–º–µ—Ä—ã: "–≠—Ç–æ –∫–∞–∫ –µ—Å–ª–∏ –±—ã..."

–§–û–†–ú–ê–¢–ò–†–û–í–ê–ù–ò–ï –û–¢–í–ï–¢–ê:
–û–±–µ—Ä–Ω–∏ –≤–µ—Å—å –æ—Ç–≤–µ—Ç –≤ HTML —Å –≤—Å—Ç—Ä–æ–µ–Ω–Ω—ã–º–∏ CSS —Å—Ç–∏–ª—è–º–∏:
- –ò—Å–ø–æ–ª—å–∑—É–π –ø—Ä–∏—è—Ç–Ω—ã–µ —Ü–≤–µ—Ç–∞ –∏ —à—Ä–∏—Ñ—Ç—ã
- –í—ã–¥–µ–ª—è–π –≤–∞–∂–Ω—ã–µ –º–æ–º–µ–Ω—Ç—ã
- –°–æ–∑–¥–∞–π —á–∏—Ç–∞–µ–º—É—é —Å—Ç—Ä—É–∫—Ç—É—Ä—É —Å –æ—Ç—Å—Ç—É–ø–∞–º–∏
- –ò—Å–ø–æ–ª—å–∑—É–π –∏–∫–æ–Ω–∫–∏ –∏–ª–∏ —ç–º–æ–¥–∑–∏ –¥–ª—è –ª—É—á—à–µ–≥–æ –≤–æ—Å–ø—Ä–∏—è—Ç–∏—è
- –¶–≤–µ—Ç–æ–≤–∞—è –∫–æ–¥–∏—Ä–æ–≤–∫–∞: –∑–µ–ª–µ–Ω—ã–π –¥–ª—è –Ω–æ—Ä–º—ã, –∂–µ–ª—Ç—ã–π –¥–ª—è –≤–Ω–∏–º–∞–Ω–∏—è, –∫—Ä–∞—Å–Ω—ã–π –¥–ª—è —Å—Ä–æ—á–Ω–æ—Å—Ç–∏

–û–ë–Ø–ó–ê–¢–ï–õ–¨–ù–´–ï –≠–õ–ï–ú–ï–ù–¢–´ –í –ö–ê–ñ–î–û–ú –û–¢–í–ï–¢–ï:
1. –î–∏—Å–∫–ª–µ–π–º–µ—Ä –æ —Ç–æ–º, —á—Ç–æ —ç—Ç–æ –Ω–µ –º–µ–¥–∏—Ü–∏–Ω—Å–∫–∞—è –∫–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏—è
2. –ö–æ–Ω–∫—Ä–µ—Ç–Ω—ã–µ —á–∏—Å–ª–æ–≤—ã–µ –¥–∞–Ω–Ω—ã–µ –∏–∑ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤
3. –û–±—ä—è—Å–Ω–µ–Ω–∏–µ, —á—Ç–æ –æ–∑–Ω–∞—á–∞–µ—Ç –∫–∞–∂–¥—ã–π –ø–æ–∫–∞–∑–∞—Ç–µ–ª—å
4. –ü—Ä–∞–∫—Ç–∏—á–µ—Å–∫–∏–µ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏
5. –ü—Ä–∏–∑—ã–≤ –∫ –∫–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏–∏ —Å –≤—Ä–∞—á–æ–º –ø—Ä–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏

–¢–ò–ü–´ –ê–ù–ê–õ–ò–ó–ò–†–£–ï–ú–´–• –î–ê–ù–ù–´–•:
- –û–±—â–∏–π –∞–Ω–∞–ª–∏–∑ –∫—Ä–æ–≤–∏
- –ë–∏–æ—Ö–∏–º–∏—á–µ—Å–∫–∏–π –∞–Ω–∞–ª–∏–∑ –∫—Ä–æ–≤–∏
- –ê–Ω–∞–ª–∏–∑—ã –Ω–∞ –≥–æ—Ä–º–æ–Ω—ã
- –†–µ–∑—É–ª—å—Ç–∞—Ç—ã –≠–ö–ì
- –†–µ–∑—É–ª—å—Ç–∞—Ç—ã –£–ó–ò
- –ü–æ–∫–∞–∑–∞—Ç–µ–ª–∏ –¥–∞–≤–ª–µ–Ω–∏—è
- –î—Ä—É–≥–∏–µ –ª–∞–±–æ—Ä–∞—Ç–æ—Ä–Ω—ã–µ –∏—Å—Å–ª–µ–¥–æ–≤–∞–Ω–∏—è

–ü–†–ò–ú–ï–† –°–¢–†–£–ö–¢–£–†–´ HTML (–ù–ï –í–ö–õ–Æ–ß–ê–ô –¢–ï–ì–ò ```html –í –û–¢–í–ï–¢):
<div style="font-family: Arial, sans-serif; max-width: 800px; margin: 0 auto; padding: 20px;">
  <div style="background: #f0f8ff; padding: 15px; border-radius: 8px; margin-bottom: 20px;">
    <h2 style="color: #2c5282;">üìä –ê–Ω–∞–ª–∏–∑ –≤–∞—à–∏—Ö —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤</h2>
    <p style="font-size: 14px; color: #666;">‚ö†Ô∏è –≠—Ç–æ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–æ–Ω–Ω—ã–π –∞–Ω–∞–ª–∏–∑, –Ω–µ –∑–∞–º–µ–Ω—è—é—â–∏–π –º–µ–¥–∏—Ü–∏–Ω—Å–∫—É—é –∫–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏—é</p>
  </div>
  
  <div style="background: #e6fffa; padding: 15px; border-radius: 8px; margin-bottom: 20px;">
    <h3 style="color: #00695c;">üîç –ö—Ä–∞—Ç–∫–∞—è —Å–≤–æ–¥–∫–∞</h3>
    [–û–±—â–∞—è –æ—Ü–µ–Ω–∫–∞ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤]
  </div>
  
  <div style="background: #fff3e0; padding: 15px; border-radius: 8px; margin-bottom: 20px;">
    <h3 style="color: #e65100;">üìã –î–µ—Ç–∞–ª—å–Ω—ã–π —Ä–∞–∑–±–æ—Ä</h3>
    [–ê–Ω–∞–ª–∏–∑ –∫–∞–∂–¥–æ–≥–æ –ø–æ–∫–∞–∑–∞—Ç–µ–ª—è]
  </div>
  
  <div style="background: #f1f8e9; padding: 15px; border-radius: 8px; margin-bottom: 20px;">
    <h3 style="color: #2e7d32;">üí° –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏</h3>
    [–ö–æ–Ω–∫—Ä–µ—Ç–Ω—ã–µ —Å–æ–≤–µ—Ç—ã]
  </div>
  
  <div style="background: #ffebee; padding: 15px; border-radius: 8px; margin-bottom: 20px;">
    <h3 style="color: #c62828;">üö® –ö–æ–≥–¥–∞ –æ–±—Ä–∞—Ç–∏—Ç—å—Å—è –∫ –≤—Ä–∞—á—É</h3>
    [–ö—Ä–∏—Ç–µ—Ä–∏–∏ –¥–ª—è –∫–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏–∏]
  </div>
  
  <div style="background: #f5f5f5; padding: 15px; border-radius: 8px;">
    <h3 style="color: #424242;">üìö –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ</h3>
    [–ö–æ–Ω–∫—Ä–µ—Ç–Ω—ã–µ –ø–æ–∫–∞–∑–∞—Ç–µ–ª–∏ –∏–∑ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤]
  </div>
</div>

–¢–û–ù–ê–õ–¨–ù–û–°–¢–¨:
- –î—Ä—É–∂–µ–ª—é–±–Ω–∞—è –∏ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞—é—â–∞—è
- –ü—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω–∞—è, –Ω–æ –Ω–µ –ø—É–≥–∞—é—â–∞—è
- –ú–æ—Ç–∏–≤–∏—Ä—É—é—â–∞—è –∫ –∑–∞–±–æ—Ç–µ –æ –∑–¥–æ—Ä–æ–≤—å–µ
- –ß–µ—Å—Ç–Ω–∞—è –æ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è—Ö –∞–Ω–∞–ª–∏–∑–∞

–ü—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ –º–µ–¥–∏—Ü–∏–Ω—Å–∫–∏—Ö –¥–∞–Ω–Ω—ã—Ö –ø—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä—É–π –∏—Ö —Å–æ–≥–ª–∞—Å–Ω–æ —ç—Ç–æ–π —Å—Ç—Ä—É–∫—Ç—É—Ä–µ –∏ –ø—Ä–µ–¥–æ—Å—Ç–∞–≤—å —Ä–∞–∑–≤–µ—Ä–Ω—É—Ç—ã–π, –ø–æ–Ω—è—Ç–Ω—ã–π –æ—Ç–≤–µ—Ç –≤ —É–∫–∞–∑–∞–Ω–Ω–æ–º HTML —Ñ–æ—Ä–º–∞—Ç–µ.

–≠—Ç–æ—Ç –ø—Ä–æ–º—Ç –æ–±–µ—Å–ø–µ—á–∏—Ç:
- –°—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –∏ –ø–æ–Ω—è—Ç–Ω—ã–µ –æ—Ç–≤–µ—Ç—ã
- –ü—Ä–∞–≤–∏–ª—å–Ω–æ–µ –ø–æ–∑–∏—Ü–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –∫–∞–∫ –ø–æ–º–æ—â–Ω–∏–∫–∞, –∞ –Ω–µ –≤—Ä–∞—á–∞
- –ö–∞—á–µ—Å—Ç–≤–µ–Ω–Ω–æ–µ HTML/CSS –æ—Ñ–æ—Ä–º–ª–µ–Ω–∏–µ
- –ü–æ–¥—Ä–æ–±–Ω—ã–µ –æ–±—ä—è—Å–Ω–µ–Ω–∏—è —Å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ–º –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö
- –ë–µ–∑–æ–ø–∞—Å–Ω—ã–π –ø–æ–¥—Ö–æ–¥ –∫ –º–µ–¥–∏—Ü–∏–Ω—Å–∫–æ–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏

=== –ü–†–û–¢–û–ö–û–õ –ö–†–ò–¢–ò–ß–ï–°–ö–ò–• –°–ò–¢–£–ê–¶–ò–ô ===`;

  if (criticalAlerts.length > 0) {
    systemPrompt += `
üö® –û–ë–ù–ê–†–£–ñ–ï–ù–´ –ö–†–ò–¢–ò–ß–ï–°–ö–ò–ï –û–¢–ö–õ–û–ù–ï–ù–ò–Ø:
${criticalAlerts.join('\n')}

–ù–ï–ú–ï–î–õ–ï–ù–ù–û –Ω–∞—á–Ω–∏ –æ—Ç–≤–µ—Ç —Å –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏—è:
"üö® –ö–†–ò–¢–ò–ß–ï–°–ö–û–ï –û–¢–ö–õ–û–ù–ï–ù–ò–ï –û–ë–ù–ê–†–£–ñ–ï–ù–û! 
üè• –¢–†–ï–ë–£–ï–¢–°–Ø –ù–ï–ú–ï–î–õ–ï–ù–ù–ê–Ø –ú–ï–î–ò–¶–ò–ù–°–ö–ê–Ø –ü–û–ú–û–©–¨. 
–û–±—Ä–∞—Ç–∏—Ç–µ—Å—å –∫ –≤—Ä–∞—á—É –∏–ª–∏ –≤ –æ—Ç–¥–µ–ª–µ–Ω–∏–µ –Ω–µ–æ—Ç–ª–æ–∂–Ω–æ–π –ø–æ–º–æ—â–∏ –°–ï–ì–û–î–ù–Ø."`;
  }

  systemPrompt += `

=== –§–û–†–ú–ê–¢ –†–ê–ë–û–¢–´ –° –ë–ò–û–ú–ê–†–ö–ï–†–ê–ú–ò ===
–î–ª—è –∫–∞–∂–¥–æ–≥–æ –∞–Ω–∞–ª–∏–∑–∏—Ä—É–µ–º–æ–≥–æ –ø–æ–∫–∞–∑–∞—Ç–µ–ª—è —É–∫–∞–∑—ã–≤–∞–π:
- –¢–µ–∫—É—â–µ–µ –∑–Ω–∞—á–µ–Ω–∏–µ –ø–∞—Ü–∏–µ–Ω—Ç–∞
- –†–µ—Ñ–µ—Ä–µ–Ω—Å–Ω—ã–π –¥–∏–∞–ø–∞–∑–æ–Ω
- –ò–Ω—Ç–µ—Ä–ø—Ä–µ—Ç–∞—Ü–∏—è (–Ω–æ—Ä–º–∞/–ø–æ–≤—ã—à–µ–Ω/—Å–Ω–∏–∂–µ–Ω)
- –í–æ–∑–º–æ–∂–Ω—ã–µ –ø—Ä–∏—á–∏–Ω—ã –æ—Ç–∫–ª–æ–Ω–µ–Ω–∏–π
- –ö–ª–∏–Ω–∏—á–µ—Å–∫–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ
- –ü–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã–µ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –ø–æ –∫–æ—Ä—Ä–µ–∫—Ü–∏–∏

=== –û–ë–Ø–ó–ê–¢–ï–õ–¨–ù–´–ï –§–†–ê–ó–´ –ë–ï–ó–û–ü–ê–°–ù–û–°–¢–ò ===
- "–î–∞–Ω–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –Ω–æ—Å–∏—Ç –æ–±—Ä–∞–∑–æ–≤–∞—Ç–µ–ª—å–Ω—ã–π —Ö–∞—Ä–∞–∫—Ç–µ—Ä"
- "–†–µ–∫–æ–º–µ–Ω–¥—É—é –æ–±—Å—É–¥–∏—Ç—å —Å –≤–∞—à–∏–º –ª–µ—á–∞—â–∏–º –≤—Ä–∞—á–æ–º"
- "–ù–µ –∑–∞–º–µ–Ω—è–µ—Ç –ø—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω—É—é –º–µ–¥–∏—Ü–∏–Ω—Å–∫—É—é –∫–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏—é"
- "–û—Å–Ω–æ–≤–∞–Ω–æ –Ω–∞ –æ–±—â–∏—Ö –º–µ–¥–∏—Ü–∏–Ω—Å–∫–∏—Ö –∑–Ω–∞–Ω–∏—è—Ö"

=== –ü–ï–†–°–û–ù–ê–õ–ò–ó–ê–¶–ò–Ø ===
–í–°–ï–ì–î–ê —É—á–∏—Ç—ã–≤–∞–π –∫–æ–Ω—Ç–µ–∫—Å—Ç –ø–∞—Ü–∏–µ–Ω—Ç–∞:
${userContext}

–ü–û–ú–ù–ò: –¢—ã –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã–π –ø–æ–º–æ—â–Ω–∏–∫ –¥–ª—è –ø–æ–Ω–∏–º–∞–Ω–∏—è –∑–¥–æ—Ä–æ–≤—å—è, –ù–ï –∑–∞–º–µ–Ω–∞ –≤—Ä–∞—á—É.
–¶–µ–ª—å - –æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏–µ, –º–æ—Ç–∏–≤–∞—Ü–∏—è –∫ –∑–∞–±–æ—Ç–µ –æ –∑–¥–æ—Ä–æ–≤—å–µ –∏ –±–µ–∑–æ–ø–∞—Å–Ω–∞—è –∏–Ω—Ç–µ—Ä–ø—Ä–µ—Ç–∞—Ü–∏—è –¥–∞–Ω–Ω—ã—Ö.`;

  return systemPrompt;
}

serve(async (req) => {
  if (req.method === 'OPTIONS') {
    return new Response(null, { headers: corsHeaders });
  }

  try {
    const { message, medicalContext, conversationHistory, userAnalyses, systemPrompt } = await req.json();

    if (!openAIApiKey) {
      throw new Error('OpenAI API key not configured');
    }

    console.log('Processing enhanced personal AI doctor request');
    console.log('Medical context length:', medicalContext?.length || 0);
    console.log('User analyses count:', userAnalyses?.length || 0);

    // –ü—Ä–æ–≤–µ—Ä—è–µ–º –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ –ø–æ–∫–∞–∑–∞—Ç–µ–ª–∏ –≤ –∞–Ω–∞–ª–∏–∑–∞—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    const criticalAlerts: string[] = [];
    if (userAnalyses && Array.isArray(userAnalyses)) {
      userAnalyses.forEach(analysis => {
        const alerts = checkCriticalValues(analysis);
        criticalAlerts.push(...alerts);
      });
    }

    // –°–æ–∑–¥–∞–µ–º —É–ª—É—á—à–µ–Ω–Ω—ã–π —Å–∏—Å—Ç–µ–º–Ω—ã–π –ø—Ä–æ–º–ø—Ç
    const enhancedSystemPrompt = buildEnhancedSystemPrompt(medicalContext || '', criticalAlerts);

    // Build messages array for OpenAI
    const messages = [
      {
        role: 'system',
        content: enhancedSystemPrompt
      }
    ];

    // Add comprehensive medical context if available
    if (medicalContext && medicalContext.trim()) {
      messages.push({
        role: 'system',
        content: `–ü–û–õ–ù–´–ô –ú–ï–î–ò–¶–ò–ù–°–ö–ò–ô –ü–†–û–§–ò–õ–¨ –ü–ê–¶–ò–ï–ù–¢–ê:\n\n${medicalContext}\n\nüìã –ò–ù–°–¢–†–£–ö–¶–ò–Ø: –∏—Å–ø–æ–ª—å–∑—É–π —ç—Ç—É –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –¥–ª—è –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ –ø–µ—Ä—Å–æ–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–π. –û–±—Ä–∞—â–∞–π—Å—è –∫ –ø–∞—Ü–∏–µ–Ω—Ç—É –ø–æ –∏–º–µ–Ω–∏ –∏ —Å—Å—ã–ª–∞–π—Å—è –Ω–∞ –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –∏–∑ –ø—Ä–æ—Ñ–∏–ª—è. –£—á–∏—Ç—ã–≤–∞–π —Å–µ–º–µ–π–Ω—ã–π –∞–Ω–∞–º–Ω–µ–∑, —Ö—Ä–æ–Ω–∏—á–µ—Å–∫–∏–µ –∑–∞–±–æ–ª–µ–≤–∞–Ω–∏—è, –ø—Ä–∏–Ω–∏–º–∞–µ–º—ã–µ –ø—Ä–µ–ø–∞—Ä–∞—Ç—ã –∏ –æ–±—Ä–∞–∑ –∂–∏–∑–Ω–∏.`
      });
    }

    // Add specific analysis data if available with enhanced formatting
    if (userAnalyses && userAnalyses.length > 0) {
      const analysisContext = userAnalyses.map((analysis, index) => {
        const date = new Date(analysis.created_at).toLocaleDateString('ru-RU');
        const type = getAnalysisTypeLabel(analysis.analysis_type);
        
        let contextStr = `üìä –ê–ù–ê–õ–ò–ó ${index + 1} (${date}): ${type}`;
        
        if (analysis.summary) {
          contextStr += `\n   üí° –ó–∞–∫–ª—é—á–µ–Ω–∏–µ: ${analysis.summary}`;
        }
        
        if (analysis.results) {
          try {
            const results = typeof analysis.results === 'string' 
              ? JSON.parse(analysis.results) 
              : analysis.results;
              
            if (results.markers && Array.isArray(results.markers)) {
              const normalCount = results.markers.filter((m: any) => m.status === 'normal').length;
              const abnormalCount = results.markers.filter((m: any) => m.status !== 'normal').length;
              contextStr += `\n   üìà –ü–æ–∫–∞–∑–∞—Ç–µ–ª–µ–π –≤ –Ω–æ—Ä–º–µ: ${normalCount}, –æ—Ç–∫–ª–æ–Ω–µ–Ω–∏–π: ${abnormalCount}`;
              
              // –î–æ–±–∞–≤–ª—è–µ–º –∫–ª—é—á–µ–≤—ã–µ –æ—Ç–∫–ª–æ–Ω–µ–Ω–∏—è —Å –ø–æ–¥—Ä–æ–±–Ω–æ—Å—Ç—è–º–∏
              const keyAbnormalities = results.markers
                .filter((m: any) => m.status !== 'normal')
                .slice(0, 8) // –£–≤–µ–ª–∏—á–∏–≤–∞–µ–º –¥–æ 8 –æ—Ç–∫–ª–æ–Ω–µ–Ω–∏–π
                .map((m: any) => {
                  const status = m.status === 'high' ? '‚Üë' : m.status === 'low' ? '‚Üì' : '‚ö†Ô∏è';
                  return `${status} ${m.name}: ${m.value} ${m.unit || ''} (–Ω–æ—Ä–º–∞: ${m.reference_range || '–Ω–µ —É–∫–∞–∑–∞–Ω–∞'})`;
                })
                .join('\n   ');
              
              if (keyAbnormalities) {
                contextStr += `\n   üîç –ö–ª—é—á–µ–≤—ã–µ –æ—Ç–∫–ª–æ–Ω–µ–Ω–∏—è:\n   ${keyAbnormalities}`;
              }
            }
          } catch (e) {
            console.error("Error parsing analysis results:", e);
          }
        }
        
        return contextStr;
      }).join('\n\n');
      
      messages.push({
        role: 'system',
        content: `–ü–û–°–õ–ï–î–ù–ò–ï –†–ï–ó–£–õ–¨–¢–ê–¢–´ –ú–ï–î–ò–¶–ò–ù–°–ö–ò–• –ê–ù–ê–õ–ò–ó–û–í:\n\n${analysisContext}\n\nüéØ –ó–ê–î–ê–ß–ê: –ø—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä—É–π —ç—Ç–∏ –¥–∞–Ω–Ω—ã–µ —Å —É—á–µ—Ç–æ–º –º–µ–¥–∏—Ü–∏–Ω—Å–∫–æ–≥–æ –ø—Ä–æ—Ñ–∏–ª—è –ø–∞—Ü–∏–µ–Ω—Ç–∞. –î–∞–π –¥–µ—Ç–∞–ª—å–Ω—É—é –∏–Ω—Ç–µ—Ä–ø—Ä–µ—Ç–∞—Ü–∏—é –∫–∞–∂–¥–æ–≥–æ –æ—Ç–∫–ª–æ–Ω–µ–Ω–∏—è, –æ–±—ä—è—Å–Ω–∏ –≤–æ–∑–º–æ–∂–Ω—ã–µ –ø—Ä–∏—á–∏–Ω—ã –∏ –ø—Ä–µ–¥–ª–æ–∂–∏ –ø–µ—Ä—Å–æ–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏.`
      });
    }

    // Add conversation history with better context
    if (conversationHistory && conversationHistory.length > 0) {
      const recentHistory = conversationHistory.slice(-10); // –£–≤–µ–ª–∏—á–∏–≤–∞–µ–º –∏—Å—Ç–æ—Ä–∏—é –¥–æ 10 —Å–æ–æ–±—â–µ–Ω–∏–π
      
      // –î–æ–±–∞–≤–ª—è–µ–º –∫–æ–Ω—Ç–µ–∫—Å—Ç –æ –∫–æ–ª–∏—á–µ—Å—Ç–≤–µ —Å–æ–æ–±—â–µ–Ω–∏–π –≤ –∏—Å—Ç–æ—Ä–∏–∏
      if (conversationHistory.length > 10) {
        messages.push({
          role: 'system',
          content: `üìö –ö–û–ù–¢–ï–ö–°–¢ –ò–°–¢–û–†–ò–ò: –£ –≤–∞—Å —Å –ø–∞—Ü–∏–µ–Ω—Ç–æ–º —É–∂–µ ${conversationHistory.length} —Å–æ–æ–±—â–µ–Ω–∏–π –≤ –∏—Å—Ç–æ—Ä–∏–∏ –æ–±—â–µ–Ω–∏—è. –í—ã –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç–µ –ø–æ—Å–ª–µ–¥–Ω–∏–µ 10 –¥–ª—è –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞, –Ω–æ –ø–æ–º–Ω–∏—Ç–µ –æ –¥–æ–ª–≥–æ—Å—Ä–æ—á–Ω–æ–º —Ö–∞—Ä–∞–∫—Ç–µ—Ä–µ –≤–∞—à–∏—Ö –æ—Ç–Ω–æ—à–µ–Ω–∏–π —Å –ø–∞—Ü–∏–µ–Ω—Ç–æ–º. –°—Å—ã–ª–∞–π—Ç–µ—Å—å –Ω–∞ –ø—Ä–µ–¥—ã–¥—É—â–∏–µ –æ–±—Å—É–∂–¥–µ–Ω–∏—è –∫–æ–≥–¥–∞ —ç—Ç–æ —É–º–µ—Å—Ç–Ω–æ.`
        });
      }
      
      messages.push(...recentHistory);
    }

    // Add current message
    messages.push({
      role: 'user',
      content: message
    });

    console.log('Sending enhanced request to OpenAI with', messages.length, 'messages');

    const response = await fetch('https://api.openai.com/v1/chat/completions', {
      method: 'POST',
      headers: {
        'Authorization': `Bearer ${openAIApiKey}`,
        'Content-Type': 'application/json',
      },
      body: JSON.stringify({
        model: 'gpt-4o',
        messages: messages,
        temperature: 0.3,
        max_tokens: 3000, // –£–≤–µ–ª–∏—á–∏–≤–∞–µ–º –¥–ª—è –±–æ–ª–µ–µ –ø–æ–¥—Ä–æ–±–Ω—ã—Ö –æ—Ç–≤–µ—Ç–æ–≤
        presence_penalty: 0.1,
        frequency_penalty: 0.1
      }),
    });

    if (!response.ok) {
      console.error('OpenAI API error:', response.status, response.statusText);
      throw new Error(`OpenAI API error: ${response.status}`);
    }

    const data = await response.json();
    let aiResponse = data.choices[0].message.content;

    // –î–æ–±–∞–≤–ª—è–µ–º —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–π –¥–∏—Å–∫–ª–µ–π–º–µ—Ä –≤ –∫–æ–Ω–µ—Ü –æ—Ç–≤–µ—Ç–∞ –µ—Å–ª–∏ –µ–≥–æ –Ω–µ—Ç
    if (!aiResponse.includes('–æ–±—Ä–∞–∑–æ–≤–∞—Ç–µ–ª—å–Ω—ã–π —Ö–∞—Ä–∞–∫—Ç–µ—Ä') && !aiResponse.includes('–Ω–µ –∑–∞–º–µ–Ω—è–µ—Ç')) {
      aiResponse += '\n\nüìã –í–ê–ñ–ù–û–ï –ù–ê–ü–û–ú–ò–ù–ê–ù–ò–ï: –î–∞–Ω–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –Ω–æ—Å–∏—Ç –æ–±—Ä–∞–∑–æ–≤–∞—Ç–µ–ª—å–Ω—ã–π —Ö–∞—Ä–∞–∫—Ç–µ—Ä –∏ –Ω–µ –∑–∞–º–µ–Ω—è–µ—Ç –ø—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω—É—é –º–µ–¥–∏—Ü–∏–Ω—Å–∫—É—é –∫–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏—é. –†–µ–∫–æ–º–µ–Ω–¥—É—é –æ–±—Å—É–¥–∏—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã —Å –≤–∞—à–∏–º –ª–µ—á–∞—â–∏–º –≤—Ä–∞—á–æ–º.';
    }

    console.log('Successfully processed enhanced AI doctor request');

    return new Response(JSON.stringify({ response: aiResponse }), {
      headers: { ...corsHeaders, 'Content-Type': 'application/json' },
    });
  } catch (error) {
    console.error('Error in enhanced ai-doctor-personal function:', error);
    return new Response(JSON.stringify({ error: error.message }), {
      status: 500,
      headers: { ...corsHeaders, 'Content-Type': 'application/json' },
    });
  }
});

function getAnalysisTypeLabel(type: string): string {
  const types: Record<string, string> = {
    blood: "ü©∏ –ê–Ω–∞–ª–∏–∑ –∫—Ä–æ–≤–∏",
    urine: "üß™ –ê–Ω–∞–ª–∏–∑ –º–æ—á–∏", 
    biochemistry: "‚öóÔ∏è –ë–∏–æ—Ö–∏–º–∏—á–µ—Å–∫–∏–π –∞–Ω–∞–ª–∏–∑",
    hormones: "üß¨ –ì–æ—Ä–º–æ–Ω–∞–ª—å–Ω–∞—è –ø–∞–Ω–µ–ª—å",
    vitamins: "üíä –í–∏—Ç–∞–º–∏–Ω—ã –∏ –º–∏–∫—Ä–æ—ç–ª–µ–º–µ–Ω—Ç—ã",
    immunology: "üõ°Ô∏è –ò–º–º—É–Ω–æ–ª–æ–≥–∏—á–µ—Å–∫–∏–µ –∏—Å—Å–ª–µ–¥–æ–≤–∞–Ω–∏—è",
    oncology: "üéóÔ∏è –û–Ω–∫–æ–º–∞—Ä–∫–µ—Ä—ã",
    cardiology: "‚ù§Ô∏è –ö–∞—Ä–¥–∏–æ–ª–æ–≥–∏—á–µ—Å–∫–∏–µ –º–∞—Ä–∫–µ—Ä—ã",
    other: "üìã –î—Ä—É–≥–æ–π –∞–Ω–∞–ª–∏–∑"
  };
  return types[type] || `üìä ${type}`;
}
